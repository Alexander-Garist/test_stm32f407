/**
  * @file    AD9833.h
  * @brief   Файл содержит прототипы функций AD9833. По умолчанию для связи по SPI используется SPI1.
				Выводы GPIO для управления передачей по SPI STM32F407 -> AD9833 и STM32F407 -> MCP41010
				по умолчанию PA3 и PA4.
  */

/** Define to prevent recursive inclusion *****************************************************************************/
#ifndef __AD9833_H__
#define __AD9833_H__

/** Includes **********************************************************************************************************/
#include "CMSIS/stm32f4xx.h"
#include "spi.h"

/** Defines ***********************************************************************************************************/
// Сброс чипа
#define AD9833_RESET_CMD		0x0100		// 0000 0001 0000 0000

// Запись регистра частоты
#define AD9833_FREQ0_REG		0x4000		// 01[00 0000 0000 0000]	14 бит частоты
#define AD9833_FREQ1_REG		0x8000		// 10[00 0000 0000 0000]	14 бит частоы

// Запись регистра фазы
#define AD9833_PHASE0_REG		0xC000		// 1100 [0000 0000 0000]	12 бит фазы
#define AD9833_PHASE1_REG		0xE000		// 1110 [0000 0000 0000]	12 бит фазы

// Режимы низкого энергопотребления
#define AD9833_SLEEP_CMD		0x00C0		// 0000 0000 1100 0000		Запрещено внутреннее тактирование + выключен DAC
#define AD9833_SLEEP1_CMD		0x0080		// 0000 0000 1000 0000		Запрещено внутреннее тактирование (не действует MCLK)
#define AD9833_SLEEP12_CMD		0x0040		// 0000 0000 0100 0000		Выключен DAC

// Выбор формы генерируемого сигнала
#define AD9833_SIN_MODE			0x0000		// 0000 0000 0000 0000  	синусоида
#define AD9833_TRIANGLE_MODE	0x0002		// 0000 0000 0000 0010  	треугольный
#define AD9833_SQUARE_MODE		0x0028		// 0000 0000 0010 1000  	прямоугольный

// Команды MCP41010
#define MCP41010_CMD_WRITE		0x1100		// 0x11 - команда потенциометра на запись данных, 0x00 - байт данных
#define MCP41010_MAX_VALUE		256			// количество значений потенциометра 0 - 255

// Описание управляющих выводов GPIO
#define AD9833_FSY_PIN			3
#define AD9833_FSY_PORT			GPIOA
#define MCP41010_CS_PIN			4
#define MCP41010_CS_PORT		GPIOA

// Частота внешнего осциллятора в модуле AD9833 в Герцах (опорная частота генератора сигналов)
#define MCLK_FREQUENCY			25000000

/** Function prototypes ***********************************************************************************************/

	/**
	! Включение тактирования порта GPIO, инициализация выводов GPIO для управления генератора сигналов AD9833 и
		цифровым потенциометром MCP41010.
		Установка высокого уровня на выводах GPIO.
	*/
void AD9833_GPIO_Init(void);

	/**
	! Инициализация модуля AD9833 с заданными параметрами.
	- SPIx - SPI модуль (SPI1, SPI2, SPI3).
	- frequency - частота выходного сигнала в Герцах.
	- amplitude - амплитуда выходного сигнала как часть от максимальной (например 128: 128/256 = 50% от максимальной).
	- mode - форма выходного сигнала (AD9833_SIN_MODE, AD9833_TRIANGLE_MODE, AD9833_SQUARE_MODE)
	*/
void AD9833_Module_Init(SPI_TypeDef* SPIx, uint32_t frequency, uint8_t amplitude, uint16_t mode);

	/**
	! Установка частоты выходного сигнала.
	- SPIx - SPI модуль (SPI1, SPI2, SPI3).
	- frequency - частота в Герцах.
	*/
void AD9833_SetFrequency(SPI_TypeDef* SPIx, uint32_t frequency);

	/**
	! Установка амплитуды выходного сигнала.
	- SPIx - SPI модуль (SPI1, SPI2, SPI3).
	- amplitude - амплитуда (0-255).
	*/
void AD9833_SetAmplitude(SPI_TypeDef* SPIx, uint8_t amplitude);

	/**
	! Установка формы выходного сигнала.
	- SPIx - SPI модуль (SPI1, SPI2, SPI3).
	- mode - режим (AD9833_SIN_MODE, AD9833_TRIANGLE_MODE, AD9833_SQUARE_MODE).
	*/
void AD9833_SetOutputMode(SPI_TypeDef* SPIx, uint16_t mode);

	/**
	! Сброс внутренних регистров AD9833. Регистры фазы, частоты и управления НЕ СБРАСЫВАЮТСЯ.
	- SPIx - SPI модуль (SPI1, SPI2, SPI3).
	*/
void AD9833_Reset(SPI_TypeDef* SPIx);

	/**
	! Включение/выключение выходного сигнала.
	- SPIx - SPI модуль (SPI1, SPI2, SPI3).
	- enable - 1 - включить, 0 - выключить.
	*/
void AD9833_EnableOutput(SPI_TypeDef* SPIx, uint8_t enable);

#endif /*__AD9833_H__ */